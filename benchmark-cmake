#!/bin/sh

prog=$(basename $0)
personality=${prog%%-cmake}
build_type=RelWithDebInfo

cc_opts="-DCMAKE_C_COMPILER=gcc"	# don't use `cc`, it may not
					# be GCC-compatible

if [ $(hostname) = "jelly" ]
then
	bmi_opts="-DBMI_INCLUDE_DIR=$HOME/wrk/bmi/install/include"
	bmi_opts="${bmi_opts} -DBMI_LIBRARY=$HOME/wrk/bmi/install/lib/libbmi.so"
	bmi_opts="${bmi_opts} -DNA_USE_BMI=on"
else
	opa_opts="-DMERCURY_USE_OPA=off"
fi

if [ $(hostname -d) = "summit.olcf.ornl.gov" ]
then
	ofi_opts="-DOFI_INCLUDE_DIR=$HOME/na-ucx/libfabric/install/include"
	ofi_opts="${ofi_opts} OFI_LIBRARY=$HOME/na-ucx/libfabric/install/lib"
	ofi_opts="${ofi_opts} -DNA_USE_OFI=on"
fi

case $personality in
tsan)
	build_type=Tsan
	personality_opts="-DMERCURY_ENABLE_DEBUG=on"
	;;
asan)
	build_type=Asan
	personality_opts="-DMERCURY_ENABLE_DEBUG=on"
	;;
benchmark)
	personality_opts=$(cat<<EOPTS
-DMERCURY_ENABLE_DEBUG=off
-DMERCURY_TESTING_USE_THREAD_POOL=off
-DMERCURY_TESTING_VERIFY_DATA=off
-DMERCURY_USE_CHECKSUMS=off
EOPTS
)
	;;
*)
	personality_opts="-DMERCURY_ENABLE_DEBUG=on"
	;;
esac

cmake	-DCMAKE_BUILD_TYPE=${build_type} \
	-DBUILD_TESTING=on \
	-DBUILD_SHARED_LIBS=on \
	${bmi_opts:-} \
	${cc_opts:-} \
	${ofi_opts:-} \
	${opa_opts:-} \
	${personality_opts:-} \
	-DNA_USE_UCX=on ..
