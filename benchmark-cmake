#!/bin/sh

prog=$(basename $0)
personality=${prog%%-cmake}
build_type=RelWithDebInfo

benchmark_opts="-DMERCURY_TESTING_USE_THREAD_POOL=off"
benchmark_opts="${benchmark_opts} -DMERCURY_TESTING_VERIFY_DATA=off"
benchmark_opts="${benchmark_opts} -DMERCURY_USE_CHECKSUMS=off"

if [ $(hostname) = "jelly" ]
then
	bmi_opts="-DBMI_INCLUDE_DIR=$HOME/wrk/bmi/install/include"
	bmi_opts="${bmi_opts} -DBMI_LIBRARY=$HOME/wrk/bmi/install/lib/libbmi.so"
	bmi_opts="${bmi_opts} -DNA_USE_BMI=on"
else
	:
fi

if [ $(hostname -d) = "summit.olcf.ornl.gov" ]
then
	ofi_opts="-DOFI_INCLUDE_DIR=$HOME/na-ucx/libfabric/install/include"
	ofi_opts="${ofi_opts} OFI_LIBRARY=$HOME/na-ucx/libfabric/install/lib"
	ofi_opts="${ofi_opts} -DNA_USE_OFI=on"
fi

case $personality in
asan)
	build_type=Asan
	personality_opts="-DMERCURY_ENABLE_DEBUG=on"
	;;
debug-benchmark)
	personality_opts="${benchmark_opts} -DMERCURY_ENABLE_DEBUG=on"
	;;
benchmark)
	personality_opts="${benchmark_opts} -DMERCURY_ENABLE_DEBUG=off"
	;;
tsan)
	build_type=Tsan
	personality_opts="-DMERCURY_ENABLE_DEBUG=on"
	;;
ubsan)
	build_type=Ubsan
	personality_opts="-DMERCURY_ENABLE_DEBUG=on"
	;;
*)
	personality_opts="-DMERCURY_ENABLE_DEBUG=on"
	;;
esac

# Don't use `cc`, it may not be GCC-compatible
cmake	-DCMAKE_BUILD_TYPE=${build_type} \
	-DBUILD_TESTING=on \
	-DBUILD_SHARED_LIBS=on \
	${bmi_opts:-} \
	-DCMAKE_C_COMPILER=${CC:-gcc} \
	-DCMAKE_C_FLAGS_DEBUG="-g -O2" \
	-DCMAKE_C_FLAGS_RELWITHDEBINFO="-g -O3 -DNDEBUG" \
	-DNA_ALLOW_MULTI_PROGRESS=off \
	${ofi_opts:-} \
	-DMERCURY_USE_OPA=off \
	${personality_opts:-} \
	-DNA_USE_UCX=on ..
